<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xixi Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --neon: #dfff31;
      --glass: rgba(255, 255, 255, 0.08);
    }
    body {
      margin:0; padding:0;
      background:#000; color:#fff;
      font-family: Arial, sans-serif;
      display:flex; flex-direction:column; height:100vh;
    }
    #video-column {
      position: sticky;
      top:0; z-index:100;
      background:black;
    }
    #stream-video {
      width:100%; height:200px; border:0;
    }
    #top-bar {
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 12px; background:rgba(0,0,0,0.7);
      font-size:14px;
    }
    #stars {
      font-weight:bold; color:var(--neon);
    }
    #redeem {
      background:var(--neon);
      border:none; border-radius:14px;
      padding:4px 10px;
      font-size:12px; font-weight:bold;
      color:#000; cursor:pointer;
    }
    #redeem:hover { opacity:0.8; }
    #chat-column {
      flex:1; overflow-y:auto; padding:10px;
    }
    .msg {
      padding:6px 0;
      font-size:0.9em;
      display:flex;
      align-items:center;
    }
    .username {
      font-weight:bold;
      margin-right:6px;
    }
    .message-text {
      font-size:0.85em;
    }
    #chat-input {
      display:flex;
      padding:10px;
      background:#111;
    }
    #chat-input input {
      flex:1;
      padding:8px;
      border:none;
      border-radius:6px;
      outline:none;
    }
    #chat-input button {
      margin-left:6px;
      background:var(--neon);
      border:none; border-radius:6px;
      padding:8px 14px;
      cursor:pointer;
      font-weight:bold;
    }
  </style>
</head>
<body>
  <div id="video-column">
    <iframe id="stream-video" src="https://xixi.live" title="Stream Video"></iframe>
    <div id="top-bar">
      <div id="stars">‚≠ê Stars: <span id="starCount">0</span></div>
      <button id="redeem">Redeem</button>
    </div>
  </div>

  <div id="chat-column"></div>

  <div id="chat-input">
    <input id="msgInput" placeholder="Type a message..."/>
    <button id="sendBtn">Send</button>
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCBnnH-pQJ0l0zOvrmoSVp37EQWubJQDxc",
    authDomain: "chatroomdb4xixi.firebaseapp.com",
    projectId: "chatroomdb4xixi",
    storageBucket: "chatroomdb4xixi.firebasestorage.app",
    messagingSenderId: "221124190278",
    appId: "1:221124190278:web:bc3d65b548ab961b602a47"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Assign a random username color for this session
  const userColor = "#" + Math.floor(Math.random()*16777215).toString(16);

  let currentUser = null;

  // Anonymous login
  auth.signInAnonymously().catch(console.error);
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      // Initialize stars for user if not exist
      const userRef = db.collection("users").doc(user.uid);
      userRef.get().then(doc => {
        if (!doc.exists) {
          userRef.set({ stars: 0 });
        }
      });
      // Listen for star updates
      userRef.onSnapshot(doc => {
        if (doc.exists) {
          document.getElementById("starCount").innerText = doc.data().stars || 0;
        }
      });
    }
  });

  // Send message
  document.getElementById("sendBtn").onclick = sendMessage;
  document.getElementById("msgInput").addEventListener("keypress", e=>{
    if(e.key==="Enter") sendMessage();
  });

  function sendMessage() {
    const text = document.getElementById("msgInput").value.trim();
    if (!text || !currentUser) return;
    db.collection("messages").add({
      uid: currentUser.uid,
      text,
      color: userColor,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("msgInput").value="";
  }

  // Render messages
  const chatCol = document.getElementById("chat-column");
  db.collection("messages").orderBy("timestamp").onSnapshot(snapshot=>{
    chatCol.innerHTML="";
    snapshot.forEach(doc=>{
      const msg = doc.data();
      renderMessage(msg.uid, msg.text, msg.color);
    });
    chatCol.scrollTop = chatCol.scrollHeight;
  });

  function renderMessage(uid, text, color){
    const div = document.createElement("div");
    div.className="msg";
    div.innerHTML = `<span class="username" style="color:${color};">${uid.substring(0,6)}:</span><span class="message-text">${text}</span>`;
    chatCol.appendChild(div);
  }
</script>
</body>
</html>
