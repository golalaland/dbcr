<style>
  .chat-message {
    margin-bottom: 6px;
    text-align: left;
  }

  .chat-username {
    font-weight: bold;
    font-size: 15px; /* more prominent */
    margin-right: 4px;
  }

  .chat-text {
    font-size: 13px; /* smaller than username */
  }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCBnnH-pQJ0l0zOvrmoSVp37EQWubJQDxc",
    authDomain: "chatroomdb4xixi.firebaseapp.com",
    projectId: "chatroomdb4xixi",
    storageBucket: "chatroomdb4xixi.firebasestorage.app",
    messagingSenderId: "221124190278",
    appId: "1:221124190278:web:bc3d65b548ab961b602a47"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  // ✅ Generate one random color per session
  let sessionColor = "#" + Math.floor(Math.random()*16777215).toString(16);

  signInAnonymously(auth);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);
      if (!docSnap.exists()) {
        await setDoc(userRef, { stars: 0 });
      } else {
        document.getElementById("star-count").textContent = "⭐ Stars: " + docSnap.data().stars;
      }
    }
  });

  // Listen for chat messages
  const q = query(collection(db, "messages"), orderBy("timestamp", "asc"));
  onSnapshot(q, (snapshot) => {
    const chatMessages = document.getElementById("chat-messages");
    chatMessages.innerHTML = "";
    snapshot.forEach((doc) => {
      const msg = doc.data();
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("chat-message");

      const usernameSpan = document.createElement("span");
      usernameSpan.classList.add("chat-username");
      usernameSpan.style.color = msg.color || "#fff";
      usernameSpan.textContent = msg.username + ":";

      const textSpan = document.createElement("span");
      textSpan.classList.add("chat-text");
      textSpan.textContent = " " + msg.text;

      msgDiv.appendChild(usernameSpan);
      msgDiv.appendChild(textSpan);
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  });

  // Send message
  document.getElementById("sendButton").onclick = async () => {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (text && currentUser) {
      await addDoc(collection(db, "messages"), {
        text,
        username: "User-" + currentUser.uid.substring(0, 5),
        color: sessionColor, // ✅ fixed per session
        timestamp: new Date()
      });
      input.value = "";

      // Update stars
      const userRef = doc(db, "users", currentUser.uid);
      const docSnap = await getDoc(userRef);
      let stars = docSnap.exists() ? docSnap.data().stars : 0;
      stars++;
      await updateDoc(userRef, { stars });
      document.getElementById("star-count").textContent = "⭐ Stars: " + stars;
    }
  };
</script>
