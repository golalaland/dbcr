<!-- Keep all your original HTML/CSS exactly as-is -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* --- Firebase config --- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* --- Auth --- */
const signupBtn = document.getElementById("signupBtn");
const signinBtn = document.getElementById("signinBtn");
const signoutBtn = document.getElementById("signoutBtn");
const profileName = document.getElementById("profileName");
const uidEl = document.getElementById("uid");

let currentUser = null;

signupBtn.addEventListener("click", async () => {
  const email = document.getElementById("authEmail").value;
  const pass = document.getElementById("authPassword").value;
  const chatId = document.getElementById("authUsername").value.trim();
  if(!chatId) return alert("Enter Chat ID");
  const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
  currentUser = { uid: userCredential.user.uid, chatId };
  profileName.textContent = chatId;
  uidEl.textContent = userCredential.user.uid;
  document.getElementById("authBox").style.display = "none";
  signoutBtn.style.display = "block";
  // Save Chat ID to Firestore
  await addDoc(collection(db, "users"), { uid: userCredential.user.uid, chatId });
});

signinBtn.addEventListener("click", async () => {
  const email = document.getElementById("authEmail").value;
  const pass = document.getElementById("authPassword").value;
  const userCredential = await signInWithEmailAndPassword(auth, email, pass);
  const chatId = document.getElementById("authUsername").value.trim() || email.split("@")[0];
  currentUser = { uid: userCredential.user.uid, chatId };
  profileName.textContent = chatId;
  uidEl.textContent = userCredential.user.uid;
  document.getElementById("authBox").style.display = "none";
  signoutBtn.style.display = "block";
});

signoutBtn.addEventListener("click", async ()=>{
  await signOut(auth);
});

onAuthStateChanged(auth, (user)=>{
  if(user){
    currentUser = { uid: user.uid, chatId: document.getElementById("authUsername").value.trim() || "Guest" };
    profileName.textContent = currentUser.chatId;
    uidEl.textContent = user.uid;
    document.getElementById("authBox").style.display = "none";
    signoutBtn.style.display = "block";
  } else {
    currentUser = null;
    profileName.textContent = "Guest";
    uidEl.textContent = "—";
    document.getElementById("authBox").style.display = "block";
    signoutBtn.style.display = "none";
  }
});

/* --- Firestore Chat --- */
const messageInput = document.getElementById("messageInput");
const sendBtnEl = document.getElementById("sendBtn");
const messagesEl = document.getElementById("messages");
const ROOM_ID = "moneyTalk"; // single room as agreed

function addMessage(chatId, text){
  const msgEl = document.createElement("div");
  msgEl.classList.add("msg");
  if(currentUser && chatId === currentUser.chatId) msgEl.classList.add("me");
  msgEl.innerHTML = `<div class="meta">${chatId}</div><div class="content">${text}</div>`;
  messagesEl.appendChild(msgEl);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

sendBtnEl.addEventListener("click", async ()=>{
  const text = messageInput.value.trim();
  if(!text || !currentUser) return;
  // Add locally
  addMessage(currentUser.chatId, text);
  messageInput.value = "";
  // Save to Firestore
  await addDoc(collection(db, "rooms", ROOM_ID, "messages"), {
    chatId: currentUser.chatId,
    text,
    timestamp: serverTimestamp()
  });
});

// Real-time listener
const messagesQuery = query(collection(db, "rooms", ROOM_ID, "messages"), orderBy("timestamp"));
onSnapshot(messagesQuery, snapshot=>{
  messagesEl.innerHTML = "";
  snapshot.forEach(doc=>{
    const data = doc.data();
    addMessage(data.chatId, data.text);
  });
});

/* --- Stars (test every 10 sec) --- */
let stars = 0;
const starCountEl = document.getElementById("starCount");
const starPopup = document.getElementById("starPopup");
const starText = document.getElementById("starText");
const closeStarBtn = document.getElementById("closeStar");

function showStarPopup(){
  stars += 1;
  starCountEl.textContent = stars;
  starText.innerHTML = `You've just earned +1 star! ⭐`;
  starPopup.style.display = "block";
  setTimeout(()=>{starPopup.style.display="none";},3000);
}
closeStarBtn.addEventListener("click",()=>{starPopup.style.display="none";});
setInterval(showStarPopup,10000);

</script>
