// Auth state
onAuthStateChanged(auth, async user=>{
  const profileName = document.getElementById("profileName");
  const uidEl = document.getElementById("uid");
  const authBox = document.getElementById("authBox");
  const dollarEl = document.getElementById("dollar");

  if(user){
    currentUser = user;
    const userRef = doc(db,"users",user.email);
    const userSnap = await getDoc(userRef);

    let data;
    if(!userSnap.exists()){
      // First time login
      const chatId = document.getElementById("authUsername").value.trim();
      data = { chatId, email: user.email, stars: 0 };
      await setDoc(userRef, data);
    } else data = userSnap.data();

    profileName.textContent = data.chatId;
    uidEl.textContent = user.uid;
    stars = data.stars || 0;
    starCountEl.textContent = stars;
    dollarEl.textContent = "$" + (stars*0.00054).toFixed(5);

    if(!sessionColors[data.chatId]) sessionColors[data.chatId] = getRandomColor();
    authBox.style.display="none";
    signoutBtn.style.display="block";

    // Listen for messages
    const messagesRef = collection(db,"messages");
    const messagesQuery = query(messagesRef, orderBy("timestamp","asc"));
    onSnapshot(messagesQuery, snap=>{
      messagesEl.innerHTML="";
      snap.forEach(doc=>{
        const msg = doc.data();
        if(!sessionColors[msg.chatId]) sessionColors[msg.chatId]=getRandomColor();
        const msgEl = document.createElement("div");
        msgEl.classList.add("msg");
        msgEl.innerHTML = `<span class="username" style="color:${sessionColors[msg.chatId]}">${msg.chatId}:</span> <span class="content">${msg.text}</span>`;
        messagesEl.appendChild(msgEl);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

  } else {
    currentUser=null;
    profileName.textContent="Guest";
    uidEl.textContent="—";
    authBox.style.display="block";
    signoutBtn.style.display="none";
    starCountEl.textContent="0";
    dollarEl.textContent="$0.00000";
  }
});

// Stars system
function showStarPopup(){
  if(!currentUser) return;
  stars+=1;
  starCountEl.textContent = stars;
  dollarEl.textContent = "$" + (stars*0.00054).toFixed(5);
  starText.innerHTML = `You've just earned +1 star! ⭐`;
  starPopup.style.display="block";
  setTimeout(()=>{starPopup.style.display="none";},3000);

  // Update Firestore
  const userRef = doc(db,"users",currentUser.email);
  setDoc(userRef,{stars:stars},{merge:true});
}
