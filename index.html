<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Xixi Chatroom</title>
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, query, orderBy, onSnapshot, setDoc, doc, getDoc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCBnnH-pQJ0l0zOvrmoSVp37EQWubJQDxc",
      authDomain: "chatroomdb4xixi.firebaseapp.com",
      projectId: "chatroomdb4xixi",
      storageBucket: "chatroomdb4xixi.firebasestorage.app",
      messagingSenderId: "221124190278",
      appId: "1:221124190278:web:bc3d65b548ab961b602a47"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const signupEmail = document.getElementById("signupEmail");
    const signupPassword = document.getElementById("signupPassword");
    const signupButton = document.getElementById("signupButton");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginButton = document.getElementById("loginButton");
    const logoutButton = document.getElementById("logoutButton");

    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const messagesDiv = document.getElementById("messages");
    const starsCounter = document.getElementById("starsCounter");

    let currentUser = null;
    let userColor = null;

    // üé® Random color generator for usernames
    function getRandomColor() {
      const colors = ["#ff4444","#44ff44","#4488ff","#ffbb33","#ff33bb","#33fff7"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // üîë Signup
    signupButton.addEventListener("click", async () => {
      try {
        const userCred = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
        const user = userCred.user;
        userColor = getRandomColor();
        await setDoc(doc(db, "users", user.uid), {
          email: user.email,
          stars: 0,
          color: userColor
        });
        alert("Signup successful!");
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // üîë Login
    loginButton.addEventListener("click", async () => {
      try {
        const userCred = await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
        currentUser = userCred.user;
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        if (userDoc.exists()) {
          userColor = userDoc.data().color || getRandomColor();
          starsCounter.innerText = "‚≠ê Stars: " + (userDoc.data().stars || 0);
        }
        alert("Login successful!");
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // üö™ Logout
    logoutButton.addEventListener("click", async () => {
      await signOut(auth);
      currentUser = null;
      starsCounter.innerText = "‚≠ê Stars: 0";
      alert("Logged out!");
    });

    // üí¨ Send Message
    sendButton.addEventListener("click", async () => {
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }
      if (messageInput.value.trim() === "") return;

      // Add message
      await addDoc(collection(db, "messages"), {
        uid: currentUser.uid,
        email: currentUser.email,
        text: messageInput.value,
        color: userColor,
        timestamp: Date.now()
      });

      // Update stars (+1 each message)
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);
      let stars = 0;
      if (userSnap.exists()) {
        stars = userSnap.data().stars || 0;
      }
      stars += 1;
      await updateDoc(userRef, { stars });
      starsCounter.innerText = "‚≠ê Stars: " + stars;

      messageInput.value = "";
    });

    // üì° Real-time chat listener
    const q = query(collection(db, "messages"), orderBy("timestamp"));
    onSnapshot(q, (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const msg = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("chat-line");
        div.innerHTML = `<span class="username" style="color:${msg.color}; font-weight:bold;">${msg.email.split('@')[0]}:</span> 
                         <span class="message">${msg.text}</span>`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

  </script>

  <style>
    body { font-family: Arial, sans-serif; background:#000; color:#fff; }
    #auth, #chat { margin: 20px; }
    #messages { background:#111; height:300px; overflow-y:scroll; padding:10px; }
    .chat-line { margin: 2px 0; text-align:left; }
    .username { margin-right:5px; }
    input, button { margin: 5px; padding: 6px; }
    #starsCounter { font-weight: bold; margin: 10px; display:block; }
  </style>
</head>
<body>
  <h2>Xixi Chatroom</h2>
  <div id="auth">
    <h3>Signup</h3>
    <input id="signupEmail" type="email" placeholder="Email">
    <input id="signupPassword" type="password" placeholder="Password">
    <button id="signupButton">Signup</button>

    <h3>Login</h3>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Password">
    <button id="loginButton">Login</button>
    <button id="logoutButton">Logout</button>
  </div>

  <div id="chat">
    <h3>Chat</h3>
    <div id="messages"></div>
    <input id="messageInput" type="text" placeholder="Type your message">
    <button id="sendButton">Send</button>
    <span id="starsCounter">‚≠ê Stars: 0</span>
  </div>
</body>
</html>
