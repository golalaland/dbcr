<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chatbox</title>
<style>
  body { margin:0; font-family: Arial; background:#000; color:#fff; display:flex; flex-direction:column; align-items:center; height:100vh; padding:10px; }
  #login-container { width:100%; max-width:400px; display:flex; flex-direction:column; gap:5px; margin-bottom:10px; }
  #login-container input { padding:8px; border-radius:4px; border:none; width:100%; }
  #login-container button { padding:8px; border:none; border-radius:4px; background:#ff4b2b; color:#fff; cursor:pointer; }
  #login-msg { color:#f00; min-height:18px; font-size:0.9em; }
  #chat-container { width:100%; max-width:500px; display:flex; flex-direction:column; flex:1; }
  #stars-counter { margin:5px 0; font-weight:bold; text-align:right; }
  #chat-feed { flex:1; overflow-y:auto; background:#111; padding:10px; border-radius:8px; margin:5px 0; }
  .message { margin-bottom:8px; padding:5px; border-radius:4px; background:#222; }
  .reactions button { background:none; border:none; cursor:pointer; margin-right:4px; font-size:1em; }
  #chat-input { display:flex; gap:5px; }
  #chat-input input { flex:1; padding:8px; border-radius:4px; border:none; }
  #chat-input button { padding:8px; border:none; border-radius:4px; background:#ff4b2b; color:#fff; cursor:pointer; }
  #logout-btn { padding:8px; border:none; border-radius:4px; background:#555; color:#fff; cursor:pointer; margin:5px 0; align-self:flex-end; }
</style>
</head>
<body>

<!-- Login / Signup on top -->
<div id="login-container">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <div>
    <button id="signup-btn">Sign Up</button>
    <button id="login-btn">Login</button>
    <button id="logout-btn" style="display:none;">Logout</button>
  </div>
  <p id="login-msg"></p>
</div>

<!-- Stars -->
<div id="stars-counter">Stars: 0</div>

<!-- Chat -->
<div id="chat-container">
  <div id="chat-feed"></div>
  <div id="chat-input">
    <input type="text" id="message" placeholder="Type a message...">
    <button id="send-btn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, increment, doc } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-auth.js";

// ---------------- Firebase Config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDmj1SQvIqI_A83EivlJfDg2z-kyUYIyrM",
  authDomain: "xixichatroomdb.firebaseapp.com",
  projectId: "xixichatroomdb",
  storageBucket: "xixichatroomdb.firebasestorage.app",
  messagingSenderId: "727244293530",
  appId: "1:727244293530:web:29559cbcc18b49831b2623"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ---------------- Elements ----------------
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const signupBtn = document.getElementById("signup-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const loginMsg = document.getElementById("login-msg");
const chatFeed = document.getElementById("chat-feed");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const starsCounter = document.getElementById("stars-counter");

let currentUser = null;
let rewardInterval = null;

// ---------------- Signup ----------------
signupBtn.onclick = async () => {
  loginMsg.textContent = "";
  try {
    const userCred = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    const uid = userCred.user.uid;
    await addDoc(collection(db,"users"), { uid, email: emailInput.value, admin:false, stars:0 });
    loginMsg.textContent = "Signup successful!";
  } catch (err) {
    loginMsg.textContent = err.message;
  }
};

// ---------------- Login ----------------
loginBtn.onclick = async () => {
  loginMsg.textContent = "";
  try {
    await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
    loginMsg.textContent = "Login successful!";
  } catch (err) {
    loginMsg.textContent = err.message;
  }
};

// ---------------- Logout ----------------
logoutBtn.onclick = () => signOut(auth);

// ---------------- Auth State ----------------
onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    emailInput.style.display="none";
    passwordInput.style.display="none";
    signupBtn.style.display="none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";

    // Load stars
    const usersRef = collection(db,"users");
    onSnapshot(usersRef, snapshot => {
      snapshot.docs.forEach(docu => {
        if(docu.data().uid === currentUser.uid){
          starsCounter.textContent = `Stars: ${docu.data().stars}`;
        }
      });
    });

    // Start reward timer
    startRewardTimer();

    // Load chat
    loadChat();
  } else {
    currentUser = null;
    emailInput.style.display="inline-block";
    passwordInput.style.display="inline-block";
    signupBtn.style.display="inline-block";
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    clearInterval(rewardInterval);
  }
});

// ---------------- Reward Timer ----------------
function startRewardTimer(){
  rewardInterval = setInterval(async ()=>{
    const usersRef = collection(db,"users");
    const snapshot = await usersRef.get();
    snapshot.docs.forEach(async docu=>{
      if(docu.data().uid === currentUser.uid){
        await updateDoc(doc(db,"users",docu.id), { stars: increment(1) });
      }
    });
  },5*60*1000);
}

// ---------------- Load Chat ----------------
function loadChat(){
  const messagesRef = collection(db,"global-messages");
  const q = query(messagesRef, orderBy("timestamp","asc"));
  onSnapshot(q, snapshot=>{
    chatFeed.innerHTML = "";
    snapshot.docs.forEach(docu=>{
      const data = docu.data();
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message");
      msgDiv.innerHTML = `<strong>${data.senderName}:</strong> ${data.text}`;
      const reactionsDiv = document.createElement("div");
      reactionsDiv.classList.add("reactions");
      ["❤️","🔥","😂"].forEach(r=>{
        const btn = document.createElement("button");
        btn.textContent = r;
        btn.onclick = async () => {
          const field = `reactions.${r}`;
          await updateDoc(doc(db,"global-messages",docu.id), {[field]: increment(1)});
        };
        reactionsDiv.appendChild(btn);
      });
      msgDiv.appendChild(reactionsDiv);
      chatFeed.appendChild(msgDiv);
    });
    chatFeed.scrollTop = chatFeed.scrollHeight;
  });
}

// ---------------- Send Message ----------------
sendBtn.onclick = async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  messageInput.value="";
  await addDoc(collection(db,"global-messages"),{
    text,
    senderId: currentUser.uid,
    senderName: currentUser.email.split("@")[0],
    timestamp: new Date()
  });
};
</script>
</body>
</html>
