<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XiXi — Chat</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#000; 
    --card:#111; 
    --muted:#9fb0c6; 
    --accent:#DFF41F; 
    --accent-dark:#a0d800;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#fff;background:var(--bg);}
  .app{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px;box-sizing:border-box;height:100%;}
  .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.6);display:flex;flex-direction:column;width:100%;max-width:500px;}
  
  .brand{text-align:center;font-weight:700;font-size:28px;color:var(--accent);}
  #starCount{text-align:center;font-size:14px;color:var(--accent);margin-bottom:12px;}

  input, button{font-family:inherit;}
  input[type="email"], input[type="password"], input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#fff;margin-bottom:8px;}
  button.btn{background:var(--accent);color:#000;border:0;padding:10px 16px;border-radius:8px;cursor:pointer;width:100%;}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--muted);padding:10px;border-radius:8px;width:100%;margin-top:4px;}

  #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;height:300px;background:#000;border-radius:8px;margin-bottom:12px;}
  .msg{padding:8px;border-radius:12px;background:var(--glass);max-width:80%;position:relative;word-wrap:break-word;}
  .msg.me{margin-left:auto;background:linear-gradient(180deg, rgba(223,244,31,0.1), rgba(223,244,31,0.05));color:#000;}
  .username{font-weight:bold;margin-right:6px;color:var(--accent);}
  .text{color:#fff;}

  .send-area{display:flex;gap:8px;}
  #messageInput{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#fff;resize:none;}
  #sendBtn{padding:10px 16px;border-radius:10px;background:var(--accent);border:none;cursor:pointer;font-weight:bold;color:#000;}

  .auth-box{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;}
  .auth-msg{text-align:center;color:var(--muted);font-size:13px;margin-bottom:8px;}

  @media(max-width:480px){
    .panel{padding:12px;width:90%;}
    #messages{height:200px;}
    #messageInput{font-size:14px;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="panel">

    <!-- BRAND & STARS -->
    <div class="brand">乂丨乂丨</div>
    <div id="starCount">⭐ Stars: 0</div>

    <!-- AUTH BOX -->
    <div class="auth-box" id="authBox">
      <input type="email" id="authEmail" placeholder="Email" />
      <input type="password" id="authPassword" placeholder="Password" />
      <button id="signinBtn" class="btn">Sign In</button>
      <button id="signupBtn" class="ghost">Sign Up</button>
      <button id="signoutBtn" class="ghost" style="display:none">Sign Out</button>
      <div id="authMsg" class="auth-msg"></div>
    </div>

    <!-- CHAT MESSAGES -->
    <div id="messages"></div>

    <!-- INPUT AREA -->
    <div class="send-area">
      <input type="text" id="messageInput" placeholder="Write your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase Modular SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYOxRJttfHH0su516jpCmG-dbFCryo3R8",
  authDomain: "chatbox-1818.firebaseapp.com",
  projectId: "chatbox-1818",
  storageBucket: "chatbox-1818.firebasestorage.app",
  messagingSenderId: "412458803473",
  appId: "1:412458803473:web:3853f6f1e7a9dd43002cb0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* --- UI Elements --- */
const signinBtn = document.getElementById('signinBtn');
const signupBtn = document.getElementById('signupBtn');
const signoutBtn = document.getElementById('signoutBtn');
const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const authMsg = document.getElementById('authMsg');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const starCountEl = document.getElementById('starCount');

let currentUser = null;
let currentUserDoc = null;

/* --- AUTH HANDLERS --- */
signupBtn.onclick = async () => {
  const email = authEmail.value.trim();
  const pw = authPassword.value.trim();
  if(!email || !pw){ authMsg.textContent='Email & password required'; return; }
  try {
    const cred = await createUserWithEmailAndPassword(auth,email,pw);
    await setDoc(doc(db,'users',cred.user.uid), { email, stars:0, createdAt:serverTimestamp() });
    authMsg.textContent = 'Signed up & logged in';
  } catch(e){ authMsg.textContent = e.message; }
};

signinBtn.onclick = async () => {
  const email = authEmail.value.trim();
  const pw = authPassword.value.trim();
  if(!email || !pw){ authMsg.textContent='Email & password required'; return; }
  try {
    await signInWithEmailAndPassword(auth,email,pw);
    authMsg.textContent = '';
  } catch(e){ authMsg.textContent = e.message; }
};

signoutBtn.onclick = ()=> signOut(auth);

/* --- LOAD USER DOC --- */
async function loadUserDoc(uid){
  const ud = await getDoc(doc(db,'users',uid));
  if(!ud.exists()){
    await setDoc(doc(db,'users',uid), { stars:0, createdAt:serverTimestamp() });
    return await getDoc(doc(db,'users',uid));
  }
  return ud;
}

/* --- SEND MESSAGE & STAR UPDATE --- */
sendBtn.onclick = async () => {
  if(!currentUser){ alert('Sign in first'); return; }
  const text = messageInput.value.trim();
  if(!text) return;
  
  await addDoc(collection(db,'messages'), {
    text,
    uid: currentUser.uid,
    username: currentUser.email.split('@')[0],
    timestamp: serverTimestamp()
  });
  
  // Update stars
  const newStars = (currentUserDoc.data().stars||0) + 1;
  await updateDoc(doc(db,'users',currentUser.uid), { stars:newStars });
  currentUserDoc = await loadUserDoc(currentUser.uid);
  starCountEl.textContent = `⭐ Stars: ${currentUserDoc.data().stars||0}`;
  
  messageInput.value='';
};

/* --- RENDER MESSAGES --- */
onSnapshot(collection(db,'messages'), snapshot => {
  messagesEl.innerHTML = '';
  snapshot.docs.sort((a,b)=>a.data().timestamp?.toMillis() - b.data().timestamp?.toMillis()).forEach(docSnap=>{
    const msg = docSnap.data();
    const div = document.createElement('div');
    div.className = 'msg' + ((msg.uid===currentUser?.
